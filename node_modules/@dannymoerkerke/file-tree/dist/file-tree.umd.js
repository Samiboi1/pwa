(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):(a="undefined"==typeof globalThis?a||self:globalThis,b(a.CustomElement={}))})(this,function(a){'use strict';class b extends HTMLElement{static get observedAttributes(){return["size"]}constructor(){super();const a=this.attachShadow({mode:"open"});a.innerHTML=`
      <style>
        :host {
          --loader-color: #008000;
          --line-width: 3px;
        }
        svg {
          animation: 2s linear infinite svg-animation;
          width: 50px;
        }
        
        circle {
          animation: 1.4s ease-in-out infinite both circle-animation;
          display: block;
          fill: transparent;
          stroke: var(--loader-color);
          stroke-linecap: round;
          stroke-dasharray: 283;
          stroke-dashoffset: 280;
          stroke-width: var(--line-width);
          transform-origin: 50% 50%;
        }
        
        @keyframes svg-animation {
          0% {
            transform: rotateZ(0deg);
          }
          100% {
            transform: rotateZ(360deg)
          }
        }
        
        @keyframes circle-animation {
          0%,
          25% {
            stroke-dashoffset: 280;
            transform: rotate(0);
          }
          
          50%,
          75% {
            stroke-dashoffset: 75;
            transform: rotate(45deg);
          }
          
          100% {
            stroke-dashoffset: 280;
            transform: rotate(360deg);
          }
        }
      </style>
      
      <div id="loader">
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45"/>
          </svg>
      </div>
    `,this.svg=this.shadowRoot.querySelector("svg")}attributeChangedCallback(a,b,c){"size"===a&&(this.svg.style.width=`${parseInt(c,10)}px`)}}customElements.get("material-loader")||customElements.define("material-loader",b);class c extends HTMLElement{constructor(){super();const a=this.attachShadow({mode:"open"});a.innerHTML=`
            <style>
                :host {
                    --header-background: #ffffff;
                    --body-background: #ffffff;
                    --footer-background: #ffffff;
                    --backdrop-color: rgba(128,128,128,0.5);
                    --dialog-width: 90%;
                    --dialog-height: auto;
                    display: block;
                }
                
                @media (min-width: 768px) {
                  :host {
                    --dialog-width: 70%;
                  }
                }
                
                @media (min-width: 1024px) {
                  :host {
                    --dialog-width: 40%;
                  }
                }
                
                @media (min-width: 1200px) {
                  :host {
                    --dialog-width: 30%;
                  }
                }
                
                #backdrop {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: var(--backdrop-color);
                    animation-name: fadein;
                    animation-duration: .2s;
                    animation-fill-mode: forwards;
                    animation-timing-function: ease-out;
                    z-index: 9999;
                }
                #modal {
                    display: grid;
                    grid-template-rows: 1fr 3fr 1fr;
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: var(--dialog-width);
                    height: var(--dialog-height);
                    background: transparent;
                    animation-name: slidedown;
                    animation-duration: .2s;
                    animation-fill-mode: forwards;
                    animation-timing-function: ease-out;
                }
                header {
                    background: var(--header-background);
                    display: flex;
                    align-items: center;
                    padding: 0 10px;
                }
                main {
                    background: var(--body-background);
                    padding: 0 10px;
                }
                footer {
                    background: var(--footer-background);
                    display: flex;
                    align-items: center;
                    padding: 0 10px;
                }
                ::slotted([slot]) {
                    margin: 10px;
                }
                ::slotted([slot]:empty) {
                    margin: 0px;
                }
                @keyframes fadein {
                    from {
                        opacity: 0;
                    }
                    to {
                        opacity: 1;
                    }
                }
                
                @keyframes slidedown {
                    from {
                        transform: translate(-50%, -65%);
                    }
                    to {
                        transform: translate(-50%, -50%);
                    }
                }
                
                @keyframes fadeout {
                    from {
                        opacity: 1;
                    }
                    to {
                        opacity: 0;
                    }
                }
                
                @keyframes slideup {
                    from {
                        transform: translate(-50%, -50%);
                    }
                    to {
                        transform: translate(-50%, -65%);
                    }
                }
                #backdrop.close {
                    animation-name: fadeout;
                    animation-duration: .2s;
                    animation-fill-mode: forwards;
                    animation-timing-function: ease-out;
                }
                #backdrop.close #modal {
                    animation-name: slideup;
                    animation-duration: .2s;
                    animation-fill-mode: forwards;
                    animation-timing-function: ease-out;
                }
                
            </style>
            
            <div id="backdrop">
                <div id="modal">
                    <header>
                        <slot name="header"></slot>
                    </header>
                    <main>
                        <slot name="body"></slot>
                    </main>
                    <footer>
                        <slot name="footer"></slot>
                    </footer>
                </div>
            </div>
        `,this.backdrop=this.shadowRoot.querySelector("#backdrop"),this.modal=this.shadowRoot.querySelector("#modal"),this.headerSlot=this.shadowRoot.querySelector("slot[name=\"header\"]"),this.bodySlot=this.shadowRoot.querySelector("slot[name=\"body\"]"),this.footerSlot=this.shadowRoot.querySelector("slot[name=\"footer\"]")}connectedCallback(){this.style.display="none",this.backdrop.addEventListener("click",this.handleClick.bind(this)),this.backdrop.addEventListener("animationend",this.handleAnimationEnd.bind(this))}handleAnimationEnd(a){"fadeout"===a.animationName&&(this.style.display="none",this.backdrop.classList.remove("close"))}handleClick(a){this.hasAttribute("modal")||a.composedPath()[0]!==this.backdrop||this.close()}open(){this.style.display="block"}close(){this.backdrop.classList.add("close")}get header(){return this.headerSlot.assignedNodes()[0]}set header(a){const b=this.headerSlot.assignedNodes();b.length&&(b[0].innerHTML=a)}get body(){return this.bodySlot.assignedNodes()[0]}set body(a){const b=this.bodySlot.assignedNodes();b.length&&(b[0].innerHTML=a)}get footer(){return this.footerSlot.assignedNodes()[0]}set footer(a){const b=this.footerSlot.assignedNodes();b.length&&(b[0].innerHTML=a)}}customElements.get("material-dialog")||customElements.define("material-dialog",c);class d extends HTMLElement{static get observedAttributes(){return["label"]}constructor(){super();const a=this.attachShadow({mode:"open"});a.innerHTML=`
      <style>
        :host {
          --button-color: transparent;
          --button-color-hover: #e2e2e2;
          --font-color: #000000;
          --font-size: 1em;
          --icon-size: 24px;
          --button-padding: 0 8px 0 8px;
          --button-padding-circle: 8px;
          --border-radius: 2px;
          display: block;
          width: fit-content;
        }
        
        button {
          border: none;
          border-radius: var(--border-radius);
          min-height: 36px;
          padding: var(--button-padding);
          font-size: var(--font-size);
          color: var(--font-color);
          background-color: var(--button-color);
          cursor: pointer;
          outline: none;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
          overflow: hidden;
        }
        
        button:hover {
          transition: background-color 0.3s ease-out;
          background-color: var(--button-color-hover);
        }
        
        #label {
          display: inline-block;
          position: relative;
          margin-right: 8px;
          margin-left: 8px;
        }
        
        :host([label]) button {
          min-width: 88px;
        }
        
        :host([raised]) {
          --button-color: #e2e2e2;
        }
        
        :host([raised]) button {
          background-color: var(--button-color);
          box-shadow: rgba(0, 0, 0, 0.12) 0px 1px 6px, rgba(0, 0, 0, 0.12) 0px 1px 4px;
        }
        
        :host([disabled]) {
          cursor: not-allowed;
        }
        
        :host([disabled]) button {
          opacity: 0.5;
          pointer-events: none;
        }
        
        :host([active]) .ripple {
          animation-name: ripple;
          animation-duration: 0.4s;
          animation-timing-function: ease-out;
          background-color: #808080;
          border-radius: 50%;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }
        
        :host([circle]) button {
          border-radius: 50%;
          --button-padding: var(--button-padding-circle);
        }
        
        ::slotted([slot="file-input"]) {
          position: absolute;
          top: 0;
          left: 0;
          bottom: 0;
          right: 0;
          opacity: 0;
          z-index: 9;
        }
        
        @keyframes ripple {
          from {
            width: 0;
            height: 0;
            opacity: 0.8;
          }
          to {
            width: 100px;
            height: 100px;
            opacity: 0.1;
          }                
        }
      </style>
      
      <button type="button">
        <div class="ripple"></div>
        <slot name="file-input"></slot>
        <slot name="left-icon"></slot>
        <span id="label"></span>
        <slot name="right-icon"></slot>
      </button>
  `,this.button=this.shadowRoot.querySelector("button"),this.label=this.shadowRoot.querySelector("#label"),this.ripple=this.shadowRoot.querySelector(".ripple")}connectedCallback(){this.hasAttribute("label")?this.label.textContent=this.getAttribute("label"):this.label.style.display="none",this.button.addEventListener("click",()=>{this.active=!0}),this.ripple.addEventListener("animationend",()=>{this.active=!1})}attributeChangedCallback(a){"label"===a&&(this.hasAttribute("label")?this.label.textContent=this.getAttribute("label"):this.label.style.display="none")}get disabled(){return this.hasAttribute("disabled")}set disabled(a){this.button.disabled=a,a?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get active(){return this.hasAttribute("active")}set active(a){a?this.setAttribute("active",""):this.removeAttribute("active")}}customElements.get("material-button")||customElements.define("material-button",d);let e;const f=(a,b)=>{e=c=>{const[d]=c.composedPath();d!==a&&10!==d.compareDocumentPosition(a)&&b()},document.body.addEventListener("click",e)},g=()=>{e&&document.body.removeEventListener("click",e)};class h extends HTMLElement{static get observedAttributes(){return[]}constructor(){super();const a=this.attachShadow({mode:"open"});a.innerHTML=`
      <style>
        :host {
          display: block;
          position: absolute;
          --font-family: -apple-system, BlinkMacSystemFont, Segoe WPC, Segoe UI, HelveticaNeue-Light, Ubuntu, Droid Sans, sans-serif;
          --font-size: 1em;
          --background-color: #b1b1b1;
          --font-color: #1e1e1e;
          --background-color-hover: #2b79d7;
          --font-color-hover: #ffffff;
        }
        :host([hidden]) {
          display: none;
        }
        ul {
          font-family: var(--font-family);
          font-size: var(--font-size);
          display: flex;
          flex-direction: column;
          list-style-type: none;
          padding: 8px 12px;
          min-width: 200px;
          background-color: var(--background-color);
          border-radius: 6px;
          box-shadow: 0 0.625rem 0.75rem 0 rgba(0, 0, 0, 0.14);
        }
        
        ul li {
          justify-content: space-between;
          padding: 4px 4px 4px 8px;
          color: var(--font-color);
          border-radius: 4px;
          position: relative;
        }
        
        ul li ul {
          display: none;
          position: absolute;
          top: 0;
          left: 100%;
        }
        
        ul li:hover {
          background-color: #2b79d7;
          color: var(--font-color-hover);
          cursor: pointer;
        }
        
        ul li[disabled],
        ul li[disabled]:hover {
          opacity: .5;
          pointer-events: none;
          cursor: default;
        }
      </style>
            
      <ul part="menu"></ul>      
    `}connectedCallback(){this.menu=this.shadowRoot.querySelector("ul"),this.hide(),f(this.menu,()=>this.hide())}set options(a){this.menu.innerHTML="",a.forEach(({label:a,callback:b,disabled:c})=>{const d=document.createElement("li"),e=a.toLowerCase().replace(" ","-").trim();c&&d.setAttribute("disabled",""),d.dataset.action=e,d.innerText=a,d.addEventListener("click",async a=>{await b(a),this.hide()}),this.menu.appendChild(d)}),this.style.opacity="0",this.removeAttribute("hidden"),this.menuHeight=this.offsetHeight,this.setAttribute("hidden",""),this.style.opacity="1"}show({x:a=0,y:b=0}){b+this.menuHeight>document.documentElement.clientHeight&&(b-=this.menuHeight),this.style.top=`${b}px`,this.style.left=`${a}px`,this.removeAttribute("hidden")}hide(){this.setAttribute("hidden","")}}customElements.define("context-menu",h);const i=new Blob([//language=JavaScript
`
  self.addEventListener('message', async ({data}) => {
    const {handle, dir, includeFileContent, ignoredDirectories, filesToIndex} = data;
  
    const currentDirectory = await iterateFiles(handle, dir, includeFileContent, ignoredDirectories, filesToIndex);
    currentDirectory.indexed = true;
  
    postMessage(currentDirectory);
  });
  
  const iterateFiles = async (directoryHandle, dir = {}, includeFileContent = false, ignoredDirectories = [], filesToIndex = []) => {
    for await (const [name, handle] of directoryHandle.entries()) {
      const path = dir.path + '/' + name;
      if(handle.kind === 'file') {
  
        dir.entries[path] = {
          path,
          handle,
          parentHandle: directoryHandle
        };
        if(includeFileContent) {
  
          const fileName = path.split('/').pop();
          const extension = fileName.split('.').pop();
          const shouldReadFile = filesToIndex.includes(extension);
  
          const file = shouldReadFile ? await handle.getFile() : null;
  
          dir.entries[path].fileContent = shouldReadFile ? await file.text() : '';
        }
      }
      else {
        dir.entries[path] = {
          path,
          handle,
          parentHandle: directoryHandle,
          entries: {}
        };
  
        if(!ignoredDirectories.includes(name)) {
          await iterateFiles(handle, dir.entries[path], includeFileContent, ignoredDirectories, filesToIndex);
        }
      }
    }
  
    dir.hasFileContent = includeFileContent;
  
    return dir;
  };
  `]),j=URL.createObjectURL(i);class k extends HTMLElement{constructor(){super();const a=this.attachShadow({mode:"open"});a.innerHTML=`
      <style>
        :host {
          --font-family: Arial;
          --font-color: #000000;
          --hover-font-color: var(--font-color);
          --hover-color: #efefef;
          --selected-color: #cccccc;
          --selected-font-color: var(--font-color);
          --width: auto;
          --font-size: .8em;
          --padding-dir: 6px;
          --padding-file: 6px;
          display: flex;
          width: var(--width);
          max-width: var(--width);
          font-size: var(--font-size);
          max-height: 100vh;
          overflow: scroll;
          font-family: var(--font-family);
        }
        
        #container {
          display: flex;
          flex-direction: column;
          width: 100%;
        }
        
        #file-container {
          overflow: scroll;
        }
        
        material-loader {
          margin-top: 20px;
          display: none;
        }
        
        :host([loading]) material-loader {
          display: block;
        }
        
        #filelist {
          list-style-type: none;
          margin: 0;
          padding: 0;
          opacity: 0;
        }
        
        #filelist.ready {
          opacity: 1; 
        }
  
        #filelist ul {
          display: none;
          list-style-type: none;
          padding: 5px 0 5px 15px;
        }
  
        #filelist li {
          cursor: pointer;
          display: flex;
          color: var(--font-color);
        }
        
        #filelist li.dir {
          align-items: center;
          padding: var(--padding-dir);
        }
        
        #filelist li[data-file] {
          padding: var(--padding-file);
        }
  
        #filelist li:hover {
          color: var(--hover-font-color);
          background-color: var(--hover-color);
        }
  
        #filelist li.selected {
          color: var(--selected-font-color);
          background-color: var(--selected-color);
        }
  
        #filelist li[data-dir] span:not(.arrow) {
          font-weight: bold;
          display: block;
          padding: 6px;
          white-space: nowrap;
        }
        #filelist li[data-dir] .arrow {
          display: inline-block;
          width: var(--font-size);
          height: var(--font-size);
          mask-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTZweCIgaGVpZ2h0PSIxNnB4IiB2aWV3Qm94PSIwIDAgMTYgMTYiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8dGl0bGU+aWNvbi9taWNyby9jaGV2cm9uL3JpZ2h0PC90aXRsZT4KICAgIDxnIGlkPSJkaXItYXJyb3ciIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxwb2x5Z29uIGlkPSJiYWNrZ3JvdW5kIiBwb2ludHM9IjAgMCAxNiAwIDE2IDE2IDAgMTYiPjwvcG9seWdvbj4KICAgICAgICA8cG9seWdvbiBpZD0ic2hhcGUiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iNiAxMS4wNiA5LjA5MDQxODM1IDggNiA0Ljk0IDYuOTUxNDE3IDQgMTEgOCA2Ljk1MTQxNyAxMiI+PC9wb2x5Z29uPgogICAgPC9nPgo8L3N2Zz4K");
          mask-size: var(--font-size);
          -webkit-mask-image: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMTZweCIgaGVpZ2h0PSIxNnB4IiB2aWV3Qm94PSIwIDAgMTYgMTYiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8dGl0bGU+aWNvbi9taWNyby9jaGV2cm9uL3JpZ2h0PC90aXRsZT4KICAgIDxnIGlkPSJkaXItYXJyb3ciIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxwb2x5Z29uIGlkPSJiYWNrZ3JvdW5kIiBwb2ludHM9IjAgMCAxNiAwIDE2IDE2IDAgMTYiPjwvcG9seWdvbj4KICAgICAgICA8cG9seWdvbiBpZD0ic2hhcGUiIGZpbGw9IiMwMDAwMDAiIHBvaW50cz0iNiAxMS4wNiA5LjA5MDQxODM1IDggNiA0Ljk0IDYuOTUxNDE3IDQgMTEgOCA2Ljk1MTQxNyAxMiI+PC9wb2x5Z29uPgogICAgPC9nPgo8L3N2Zz4K");
          -webkit-mask-size: var(--font-size);
          background-color: var(--font-color);
          transform: rotate(0deg);
        }
        
        #filelist ul > li[data-file] {
          margin-left: 17px;
        }
        
        #filelist ul ~ li[data-file] {
          margin-left: 25px;
        }
        
        #filelist li.open + ul {
          display: block;
        }
  
        #filelist li[data-dir].open .arrow {
          transform: rotate(90deg);
          transform-origin: center center;
          transition: transform 0.3s ease-out;
        }
        
        #confirm-dialog-cancel {
          margin-right: 10px;
        }
        
        material-dialog material-button {
          margin-bottom: 10px;
        }
        
        .not-supported {
          color: #ff0000;
          display: none;
        }
      </style>
      
      <div id="container">
        <p class="not-supported">
          Unfortunately the File System Access API is not supported on your device.
        </p>
        <slot name="browse-button"></slot>
        <div id="file-container">
          <material-loader size="32"></material-loader>
          <ul id="filelist"></ul>       
        </div>
      </div>
      
      <context-menu></context-menu>
      
      <material-dialog id="confirm-dialog">
        <h3 slot="header">Are you sure?</h3>
        <div slot="body"></div>
  
        <material-button label="Cancel" id="confirm-dialog-cancel" raised slot="footer"></material-button>
        <material-button label="OK" id="confirm-dialog-ok" raised slot="footer"></material-button>
      </material-dialog>
    `,this.selectedFileElement=null}connectedCallback(){this.isSupported()||(this.shadowRoot.querySelector(".not-supported").style.display="block"),this.ignoredDirectories=[".git","node_modules","dist"],this.filesToIndex=["txt","js","ts","css","html","json"],this.openDirs=new Set,this.fileList=this.shadowRoot.querySelector("#filelist"),this.fileContainer=this.shadowRoot.querySelector("#file-container"),this.confirmDialog=this.shadowRoot.querySelector("#confirm-dialog"),this.confirmCancelButton=this.shadowRoot.querySelector("#confirm-dialog-cancel"),this.confirmOkButton=this.shadowRoot.querySelector("#confirm-dialog-ok"),this.confirmCancelButton.addEventListener("click",()=>this.confirmDialog.close());const a=this.shadowRoot.querySelector("slot[name=\"browse-button\"]").assignedNodes()[0];a&&(a.addEventListener("click",()=>this.openDirectory()),!this.isSupported()&&(a.disabled=!0)),this.fileList.addEventListener("click",a=>this.openFileOrDirectory(a)),this.fileList.addEventListener("contextmenu",a=>this.handleRightClick(a))}isSupported(){return"showDirectoryPicker"in window}async confirm({body:a,callback:b}){return this.confirmDialog.body=a,this.confirmDialog.open(),new Promise(a=>{this.confirmCancelButton.onclick=()=>{this.confirmDialog.close(),a(!1)},this.confirmOkButton.onclick=async()=>{await b(),this.confirmDialog.close(),a(!0)}})}async hasReadWritePermission(a){return"granted"===(await a.queryPermission({mode:"readwrite"}))}async getReadWritePermission(a){if(!(await this.hasReadWritePermission(a))){const b=await a.requestPermission({mode:"readwrite"});if("granted"!==b)throw new Error("No permission to open file")}return!0}async getFileFromHandle(a){const b=await a.getFile(),c=b.name,d=await this.getFileContents(b),{type:e}=b;//this.getFileType(file);
return{name:c,contents:d,type:e}}async getFileContents(a){switch(a.type){case"image/png":case"image/jpg":case"image/jpeg":case"image/gif":return new Promise(b=>{const c=new FileReader;c.addEventListener("loadend",()=>b(c.result)),c.readAsDataURL(a)});default:return a.text();}}async openFileByPath(a){const[b,{handle:c}]=this.findEntry(a,this.currentDirectory);c&&(await this.openFileHandle(c),this.highlightFile(a))}async openFileHandle({path:a,handle:b}){this.currentFileHandle=b,await this.getReadWritePermission(b);const c=await this.getFileFromHandle(b);this.dispatchEvent(new CustomEvent("file-selected",{composed:!0,bubbles:!0,detail:{file:c,path:a,handle:b}})),this.highlightFile(a)}async saveFile(a,b=this.currentFileHandle){const c=await b.createWritable();await c.write({type:"write",data:a}),await c.close(),this.currentFileHandle=b;const d=await this.getFileFromHandle(b);return await this.refresh(),{file:d,handle:b}}async saveFileAs(a){const b=await window.showSaveFilePicker({suggestedName:this.currentFileHandle.name});await this.saveFile(a,b),await this.openFileHandle(b)}async newFile(a){const b=await window.showSaveFilePicker(a),c=await this.getFileFromHandle(b);return this.currentFileHandle=b,await this.refresh(),{file:c,handle:b}}async entryExists(a,b){for await(const[c,d]of a.entries())if(c===b)return!0;return!1}async deleteEntry({handle:a,parentHandle:b}){const c="directory"===a.kind,d=`Are you sure you want to delete ${a.name}?`;return this.confirm({body:d,callback:async()=>{await b.removeEntry(a.name,{recursive:c}),await this.refresh()}})}async pasteEntry(a,b){const c=b.path.split("/").pop(),d=async()=>{await this.createEntry(a,b,c),await this.refresh()};if(await this.entryExists(a,c)){await this.confirm({body:`${c} already exists, overwrite?`,callback:d})}else await d()}async createEntry(a,b,c){const d=b.handle;if("file"===d.kind){const b=await a.getFileHandle(c,{create:!0}),{contents:e}=await this.getFileFromHandle(d);return await this.saveFile(e,b),b}const e=await a.getDirectoryHandle(c,{create:!0}),f=await this.iterateFiles(d,b,!0);for(const[d,g]of Object.entries(f.entries)){const a=d.split("/").pop();await this.createEntry(e,g,a)}return e}async renameEntry(a,b){const[c,{handle:d,parentHandle:e,entries:f}]=this.findEntry(a),g=b.split("/").pop(),h="directory"===d.kind;await this.createEntry(e,{path:c,handle:d,entries:f},g),await e.removeEntry(d.name,{recursive:h}),await this.refresh()}async duplicateEntry(a,b){const[c,{handle:d,parentHandle:e,entries:f}]=this.findEntry(a),g=b.split("/").pop();await this.createEntry(e,{path:c,handle:d,entries:f},g),await this.refresh()}async openFile(){const[a]=await window.showOpenFilePicker();await this.openFileHandle(a)}async openDirectory(){try{return this.currentDirectoryHandle=await window.showDirectoryPicker(),await this.browseDirectory(this.currentDirectoryHandle),this.currentDirectoryHandle}catch(a){console.log("Request aborted")}}async browseDirectory(a){this.dispatchEvent(new CustomEvent("browsing")),await this.getReadWritePermission(a),this.fileList.innerHTML="",this.loading=!0,this.currentDirectoryHandle=a;const b={path:this.currentDirectoryHandle.name,indexed:!1,handle:this.currentDirectoryHandle,entries:{}};this.currentDirectory=await this.iterateFiles(this.currentDirectoryHandle,b),this.loading=!1,this.listFiles(this.currentDirectory,this.fileList),this.currentDirectory.indexed||(await this.indexDirectory()),this.fileList.classList.add("ready"),this.dispatchEvent(new CustomEvent("ready"))}async iterateFiles(a,b={},c=!1){for await(const[d,e]of a.entries()){const f=`${b.path}/${d}`;b.entries[f]={path:f,handle:e,parentHandle:a,...("directory"===e.kind&&{entries:{}})},"directory"===e.kind&&c&&(await this.iterateFiles(e,b.entries[f],c))}return b}listFiles(a,b){Object.entries(a.entries).sort().sort(([c,d],[a,e])=>"file"===d.handle.kind&&"file"!==e.handle.kind?1:"file"===e.handle.kind&&"file"!==d.handle.kind?-1:0).forEach(([a,c])=>{const d=a.split("/").pop();if("file"===c.handle.kind)b.insertAdjacentHTML("beforeend",`<li data-file="${a}"><span>${d}</span></li>`);else{const e=this.openDirs.has(a)?"dir open":"dir";b.insertAdjacentHTML("beforeend",`<li class="${e}" data-dir="${a}">
          <span class="arrow"></span>
          <span>${d}</span>
        </li>`);const f=b.insertAdjacentElement("beforeend",document.createElement("ul"));this.listFiles(c,f)}})}async indexDirectory(){const a={path:this.currentDirectoryHandle.name,handle:this.currentDirectoryHandle,entries:{}},b=new Worker(j);b.addEventListener("message",({data:a})=>{this.currentDirectory=a,this.dispatchEvent(new CustomEvent("indexed"))});const c={handle:this.currentDirectoryHandle,ignoredDirectories:this.ignoredDirectories,filesToIndex:this.filesToIndex,dir:a};b.postMessage(c)}async indexFileContent(){return new Promise((a,b)=>{const c={path:this.currentDirectoryHandle.name,handle:this.currentDirectoryHandle,entries:{}},d=new Worker(j);d.addEventListener("message",({data:b})=>{this.currentDirectory=b,a(b)}),d.addEventListener("messageerror",a=>{console.log("error from worker",a),b(a)});const e={handle:this.currentDirectoryHandle,ignoredDirectories:this.ignoredDirectories,filesToIndex:this.filesToIndex,includeFileContent:!0,dir:c};d.postMessage(e)})}async openFileOrDirectory(a){const b=[...a.composedPath()].find(a=>a.matches&&a.matches("li[data-file]")),c=[...a.composedPath()].find(a=>a.matches&&a.matches("li[data-dir]"));if(b){const a=b.dataset.file,[c,{handle:d}]=this.findEntry(a,this.currentDirectory);if(d)try{await this.openFileHandle({path:c,handle:d}),this.highlightFile(a)}catch(a){await this.refresh()}}if(c){c.classList.toggle("open");const a=c.dataset.dir,[b,d]=this.findEntry(a,this.currentDirectory);c.classList.contains("open")?this.openDirs.add(a):this.openDirs.delete(a);const e=c.nextElementSibling;// lazily iterate directory
0===Object.entries(d.entries).length&&(await this.iterateFiles(d.handle,d)),0===e.childElementCount&&this.listFiles(d,e),c.classList.contains("open")||e.querySelectorAll(".dir").forEach(a=>{if(a.classList.contains("open")){a.classList.remove("open");const b=a.dataset.dir;this.openDirs.delete(b)}})}}async handleRightClick(a){a.preventDefault();const b=[...a.composedPath()].find(a=>a.matches("li[data-file]")||a.matches("li[data-dir]"));if(b){const c=b.dataset.file||b.dataset.dir,[d,e]=this.findEntry(c,this.currentDirectory);if(e){const{path:c,handle:d,parentHandle:f,entries:g}=e;try{await this.getReadWritePermission(d);const{pageX:e,pageY:h}=a,i={path:c,handle:d,parentHandle:f,entries:g,x:e,y:h,domElement:b};"file"===d.kind&&(this.highlightFile(c),i.file=await this.getFileFromHandle(d)),this.dispatchEvent(new CustomEvent("right-click",{composed:!0,bubbles:!0,detail:i})),this.openContextMenu(i)}catch(a){console.log(a),await this.refresh()}}}}openContextMenu(a){const{path:b,handle:c,parentHandle:d,entries:e,x:h,y:i,domElement:j}=a;this.contextMenu=this.shadowRoot.querySelector("context-menu");const k="file"===c.kind?"file":"directory";this.contextMenu.options=[{label:"Delete",callback:()=>{this.deleteEntry({handle:c,parentHandle:d})}},{label:"Copy",callback:async()=>{this.copiedEntry={path:b,handle:c,entries:e}}},{label:"Paste",callback:async()=>{await this.pasteEntry(c,this.copiedEntry),this.copiedEntry=null},disabled:!this.copiedEntry},{label:"Rename",callback:()=>{const a=document.createElement("input"),b=j.querySelector("span").textContent;a.value=b;const c=j.dataset.file||j.dataset.dir,d=()=>{a.remove(),j.querySelector("span").textContent=b,g()};setTimeout(()=>{f(a,d)}),a.addEventListener("keydown",async({key:e})=>{if("Escape"===e&&d(),"Enter"===e){const e=a.value.trim();if(e===b)d();else if(""!==e){const a=c.split("/");a.pop(),a.push(e);const b=a.join("/");d(),await this.renameEntry(c,b)}else a.value=b}}),j.querySelector("span").textContent="",j.querySelector("span").appendChild(a),a.focus()}},{label:`Copy ${k}`,callback:()=>{const a=j.dataset.file||j.dataset.dir;this.duplicateEntry(a)}},{label:`New file`,callback:async()=>{const a="directory"===k?c:d;await this.newFile({startIn:a})}}],this.contextMenu.show({x:h,y:i})}highlightFile(a){const[b,c]=this.findEntry(a,this.currentDirectory);if(c){this.currentFileHandle=c.handle,this.selectedFileElement&&this.selectedFileElement.classList.toggle("selected"),this.selectedFileElement=this.shadowRoot.querySelector(`li[data-file="${a}"]`),this.selectedFileElement&&this.selectedFileElement.classList.toggle("selected");const b=c.path.split("/");b.slice(1).reduce((a,c,d)=>{a.push(c);const e=d+1===b.length-1,f=a.join("/"),g=e?`li[data-file="${f}"]`:`li[data-dir="${f}"]`,h=e?`selected`:`open`,i=this.shadowRoot.querySelector(g);if(i)if(i.classList.add(h),e)this.selectedFileElement=this.shadowRoot.querySelector(`li[data-file="${f}"]`),this.elementIsInView(this.selectedFileElement)||(this.fileContainer.scrollTop=this.selectedFileElement.offsetTop);else{this.openDirs.add(f);const[a,b]=this.findEntry(f,this.currentDirectory),c=i.nextElementSibling;c.innerHTML="",this.listFiles(b,c)}return a},b.slice(0,1))}}elementIsInView(a){const{top:b,bottom:c}=a.getBoundingClientRect();return 0<=b&&c<=(window.innerHeight||document.documentElement.clientHeight)}unhighlightFile(a){const b=this.shadowRoot.querySelector(`li[data-file="${a}"]`);b&&b.classList.contains("selected")&&(b.classList.remove("selected"),this.selectedFileElement=null,this.currentFileHandle=null)}isIgnoredEntry(a){return a.split("/").some(a=>this.ignoredDirectories.includes(a))}getSearchRegex(a,{matchWholeWord:b,caseSensitive:c,regex:d}){const e=b?`\\b${a}\\b`:a;return c?new RegExp(e):new RegExp(e,"i")}findEntry(a,b=this.currentDirectory){const c=[...Object.entries(b.entries)];return c.find(([b,c])=>a===b)||c.filter(([a,{handle:b}])=>"directory"===b.kind).flatMap(([b,c])=>a===b?c:this.findEntry(a,c))}async findInFiles(a,b={matchWholeWord:!1,caseSensitive:!1,regex:!1}){this.currentDirectory.hasFileContent||(await this.indexFileContent());const c=this.getSearchRegex(a,b),d=this.searchInFiles(c),e=d.map(({path:b,fileContent:d})=>{const e=d.split("\n").map((a,b)=>({line:b+1,content:a})).filter(({content:a})=>c.test(a))// whole word: new RegExp(`\\b${query}\\b`).test(content)
.map(({content:b,line:c})=>({line:c,content:b.trim().replaceAll("<","&lt;").replaceAll(">","&gt;").replace(a,`<span class="highlight">${a}</span>`)}));return{path:b,rows:e}});return{query:a,results:e}}searchInFiles(a,b=this.currentDirectory){const c=[...Object.values(b.entries)],d=({handle:b,path:c,fileContent:d})=>"file"===b.kind&&!this.isIgnoredEntry(c)&&a.test(d);return[...c.filter(d),...c.filter(({handle:a,path:b})=>"directory"===a.kind&&!this.isIgnoredEntry(b)).flatMap(b=>d(b)?b:this.searchInFiles(a,b))]}findFile(a){const b=this.searchFile(a);return{query:a,results:b}}searchFile(c,d=this.currentDirectory){const e=[...Object.values(d.entries)],f=a=>this.fuzzysearch(c,a.path.split("/").pop());return""===c?[]:[...e.filter(f),...e.filter(({handle:a,path:b})=>"directory"===a.kind&&!this.isIgnoredEntry(b)).flatMap(a=>f(a)?a:this.searchFile(c,a))].sort((d,a)=>d.path.includes(c)?-1:a.path.includes(c)?1:0).map(a=>{const b={...a,highlight:this.fuzzyHighlight(c,a.path)};return b})}fuzzyHighlight(a,b){const c=b.split("/"),d=c.pop(),e=[...a],f=[...d];if(d.includes(a))return[c.join("/"),d.replace(a,`<span class="highlight">${a}</span>`)];const g=f.map(a=>a===e[0]?(e.shift(),`<span class="highlight">${a}</span>`):a);return[c.join("/"),g.join("")]}fuzzysearch(a,b){const c=a.length,d=b.length;if(c>d)return!1;if(c===d)return a===b;const e=[...a],f=[...b];return f.forEach(a=>{a===e[0]&&e.shift()}),0===e.length}async refresh(){await this.browseDirectory(this.currentDirectoryHandle);const a=[...this.openDirs];for(const b of a){const[a,c]=this.findEntry(b,this.currentDirectory);// previously opened directory no longer exists
if(c===void 0)this.openDirs.delete(b);else if(0===Object.entries(c.entries).length){await this.iterateFiles(c.handle,c);const a=this.shadowRoot.querySelector(`li[data-dir="${b}"] + ul`);this.listFiles(c,a)}}}set loading(a){a?this.setAttribute("loading",""):this.removeAttribute("loading")}get loading(){return this.hasAttribute("loading")}}customElements.define("file-tree",k),a.FileTree=k,Object.defineProperty(a,"__esModule",{value:!0})});
